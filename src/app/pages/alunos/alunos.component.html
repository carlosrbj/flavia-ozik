<div class="alunos-container">
  <!-- Lista de Alunos -->
  <div *ngIf="!alunoSelecionado && !modoEdicao" class="lista-alunos">
    <div class="grid">
      <div class="col-12 md:col-3">
        <div class="card">
          <div class="flex align-items-center gap-2">
            <i class="pi pi-users"></i>
            <span>Total de alunos</span>
          </div>
          <h2 class="mt-2">{{ totalAlunos }}</h2>
        </div>
      </div>
      <div class="col-12 md:col-3">
        <div class="card">
          <div class="flex align-items-center gap-2">
            <i class="pi pi-user-plus"></i>
            <span>Alunos ativos</span>
          </div>
          <h2 class="mt-2">{{ totalAtivos }}</h2>
        </div>
      </div>
      <div class="col-12 md:col-3">
        <div class="card">
          <div class="flex align-items-center gap-2">
            <i class="pi pi-wallet"></i>
            <span>Receita mensal</span>
          </div>
          <h2 class="mt-2">{{ receitaMensal | currency:'BRL' }}</h2>
        </div>
      </div>
      <div class="col-12 md:col-3">
        <div class="card">
          <div class="flex align-items-center gap-2">
            <i class="pi pi-exclamation-triangle"></i>
            <span>Mensalidades atrasadas</span>
          </div>
          <h2 class="mt-2">{{ mensalidadesAtrasadas }}</h2>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card">
        <div class="flex justify-content-between align-items-center mb-3">
          <h3 class="m-0">Alunos</h3>
          <button pButton label="Novo Aluno" icon="pi pi-plus" (click)="abrirDialogNovo()"></button>
        </div>
        <p-table [value]="alunos" [paginator]="true" [rows]="10" responsiveLayout="scroll">
          <ng-template pTemplate="header">
            <tr>
              <th>Aluno</th>
              <th>Telefone</th>
              <th>Email</th>
              <th>Valor da mensalidade</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-aluno>
            <tr>
              <td>
                <div class="aluno-avatar">
                  <img [src]="aluno.fotoUrl" *ngIf="aluno.fotoUrl" [alt]="aluno.nome" />
                </div>
                {{ aluno.nome }}
              </td>
              <td>{{ aluno.telefone }}</td>
              <td>{{ aluno.email }}</td>
              <td>{{ aluno.valorMensalidade | currency:'BRL' }}</td>
              <td>
                <p-tag [value]="aluno.ativo ? 'Ativo' : 'Inativo'" [severity]="aluno.ativo ? 'success' : 'danger'"></p-tag>
              </td>
              <td>
                <button pButton icon="pi pi-eye" class="p-button-text" (click)="visualizar(aluno)" pTooltip="Visualizar" tooltipPosition="bottom"></button>
                <button pButton icon="pi pi-pencil" class="p-button-text" (click)="editar(aluno)" pTooltip="Editar" tooltipPosition="bottom"></button>
                <button pButton icon="pi pi-trash" class="p-button-text p-button-danger" (click)="excluir(aluno)" pTooltip="Excluir" tooltipPosition="bottom"></button>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>

  <!-- Visualização Detalhada do Aluno -->
  <div *ngIf="alunoSelecionado && !modoEdicao" class="visualizacao-aluno">
    <div class="flex justify-content-between align-items-center mb-3">
      <button pButton icon="pi pi-arrow-left" label="Voltar à Lista" class="p-button-outlined" (click)="voltarLista()"></button>
      <h2 class="m-0">Visualizando: {{ alunoSelecionado.nome }}</h2>
    </div>
    
    <app-aluno-view 
      [aluno]="alunoSelecionado"
      (editarAluno)="editar($event)"
      (excluirAluno)="excluir($event)"
      (gerarMensalidade)="abrirDialogMensalidade($event)"
      (agendarAula)="abrirDialogAula($event)"
      (agendarQueima)="abrirDialogQueima($event)">
    </app-aluno-view>
  </div>


</div>

<!-- Dialog para Novo/Editar Aluno -->
<p-dialog [header]="alunoEmEdicao ? 'Editar Aluno' : 'Novo Aluno'" [(visible)]="dialogNovoVisivel" [modal]="true" [style]="{width: '600px'}">
  <form class="p-fluid">
    <div class="field">
      <label>Nome completo</label>
      <input pInputText [(ngModel)]="alunoEmFormulario.nome" name="nome" />
    </div>
    
    <div class="field">
      <label>Foto do Aluno</label>
      <div class="photo-upload-container">
        <div class="aluno-avatar" *ngIf="alunoEmFormulario.fotoUrl; else photoPlaceholder">
          <img [src]="alunoEmFormulario.fotoUrl" alt="Foto do aluno" />
          <button type="button" pButton icon="pi pi-times" class="p-button-rounded p-button-danger p-button-text remove-photo" 
                  (click)="removerFoto()" pTooltip="Remover foto"></button>
        </div>
        <ng-template #photoPlaceholder>
          <div class="photo-placeholder">
            <i class="pi pi-user"></i>
            <span>Sem foto</span>
          </div>
        </ng-template>
        <div class="photo-actions">
          <input type="file" #fileInput accept="image/*" (change)="onFotoSelecionada($event)" style="display: none;" />
          <button type="button" pButton label="Escolher Foto" icon="pi pi-upload" 
                  class="p-button-outlined" (click)="fileInput.click()"></button>
        </div>
        <small class="photo-info">Formatos aceitos: JPG, PNG (máx. 5MB)</small>
      </div>
    </div>
    
    <div class="field">
      <label>Data de início</label>
      <input pInputText [(ngModel)]="alunoEmFormulario.dataInicio" name="dataInicio" type="date" />
    </div>
    <div class="grid">
      <div class="col-12 md:col-6 field">
        <label>Telefone</label>
        <input pInputText [(ngModel)]="alunoEmFormulario.telefone" name="telefone" />
      </div>
      <div class="col-12 md:col-6 field">
        <label>Email</label>
        <input pInputText [(ngModel)]="alunoEmFormulario.email" name="email" />
      </div>
    </div>
    <div class="grid">
      <div class="col-12 md:col-6 field">
        <label>Valor mensalidade</label>
        <input pInputText [(ngModel)]="alunoEmFormulario.valorMensalidade" name="valorMensalidade" type="number" />
      </div>
      <div class="col-12 md:col-6 field">
        <label>Status</label>
        <p-dropdown [options]="statusOptions" optionLabel="label" optionValue="value" [(ngModel)]="alunoEmFormulario.ativo" name="ativo"></p-dropdown>
      </div>
    </div>
    <div class="field">
      <label>Observações</label>
      <textarea pInputTextarea rows="3" [(ngModel)]="alunoEmFormulario.observacoes" name="observacoes"></textarea>
    </div>
  </form>
  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" class="p-button-text" (click)="cancelarFormulario()"></button>
    <button pButton [label]="alunoEmEdicao ? 'Salvar' : 'Cadastrar'" (click)="salvarAluno()"></button>
  </ng-template>
</p-dialog>

<!-- Dialog para Gerar Nova Mensalidade -->
<p-dialog header="Gerar Nova Mensalidade" [(visible)]="dialogMensalidadeVisivel" [modal]="true" [style]="{width: '500px'}">
  <form class="p-fluid">
    <div class="field">
      <label>Data de Vencimento</label>
      <p-calendar 
        [(ngModel)]="novaMensalidade.dataVencimento" 
        name="dataVencimento"
        dateFormat="dd/mm/yy"
        placeholder="Selecione a data de vencimento"
        [showIcon]="true">
      </p-calendar>
    </div>
    
    <div class="grid">
      <div class="col-12 md:col-6 field">
        <label>Valor</label>
        <p-inputNumber 
          [(ngModel)]="novaMensalidade.valor" 
          name="valor" 
          mode="currency" 
          currency="BRL" 
          locale="pt-BR"
          placeholder="0,00">
        </p-inputNumber>
      </div>
      <div class="col-12 md:col-6 field">
        <label>Desconto</label>
        <p-inputNumber 
          [(ngModel)]="novaMensalidade.desconto" 
          name="desconto" 
          mode="currency" 
          currency="BRL" 
          locale="pt-BR"
          placeholder="0,00">
        </p-inputNumber>
      </div>
    </div>
    
    <div class="field">
      <label>Observações</label>
      <textarea pInputTextarea rows="2" [(ngModel)]="novaMensalidade.observacoes" name="observacoes" placeholder="Observações sobre a mensalidade"></textarea>
    </div>
  </form>
  
  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" class="p-button-text" (click)="dialogMensalidadeVisivel=false"></button>
    <button pButton label="Gerar Mensalidade" (click)="gerarMensalidade()" [disabled]="!novaMensalidade.dataVencimento || !novaMensalidade.valor"></button>
  </ng-template>
</p-dialog>

<!-- Dialog para Agendar Nova Aula -->
<p-dialog header="Agendar Nova Aula" [(visible)]="dialogAulaVisivel" [modal]="true" [style]="{width: '500px'}">
  <form class="p-fluid">

    
    <div class="grid">
      <div class="col-12 md:col-6 field">
        <label>Data</label>
        <p-calendar 
          [(ngModel)]="novaAula.data" 
          name="data"
          dateFormat="dd/mm/yy"
          placeholder="Selecione a data">
        </p-calendar>
      </div>
      <div class="col-12 md:col-6 field">
        <label>Horário</label>
        <p-calendar 
          [(ngModel)]="novaAula.horario" 
          name="horario"
          timeOnly="true"
          hourFormat="24"
          placeholder="Selecione o horário">
        </p-calendar>
      </div>
    </div>
    
    <div class="grid">
      <div class="col-12 md:col-6 field">
        <label>Duração (horas)</label>
        <p-inputNumber 
          [(ngModel)]="novaAula.duracao" 
          name="duracao" 
          min="1" 
          max="8" 
          placeholder="3">
        </p-inputNumber>
      </div>
      <div class="col-12 md:col-6 field">
        <label>Conteúdo</label>
        <input pInputText [(ngModel)]="novaAula.conteudo" name="conteudo" placeholder="Técnica ou conteúdo da aula" />
      </div>
    </div>
    
    <div class="field">
      <label>Observações</label>
      <textarea pInputTextarea rows="2" [(ngModel)]="novaAula.observacoes" name="observacoes" placeholder="Observações sobre a aula"></textarea>
    </div>
  </form>
  
  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" class="p-button-text" (click)="dialogAulaVisivel=false"></button>
    <button pButton label="Agendar Aula" (click)="agendarAula()" [disabled]="!novaAula.data || !novaAula.horario"></button>
  </ng-template>
</p-dialog>

<!-- Dialog para Agendar Nova Queima -->
<p-dialog header="Agendar Nova Queima" [(visible)]="dialogQueimaVisivel" [modal]="true" [style]="{width: '500px'}">
  <form class="p-fluid">

    
    <div class="grid">
      <div class="col-12 md:col-6 field">
        <label>Data</label>
        <p-calendar 
          [(ngModel)]="novaQueima.data" 
          name="data"
          dateFormat="dd/mm/yy"
          placeholder="Selecione a data">
        </p-calendar>
      </div>
      <div class="col-12 md:col-6 field">
        <label>Tipo</label>
        <p-dropdown 
          [options]="tiposQueima" 
          optionLabel="label" 
          optionValue="value" 
          [(ngModel)]="novaQueima.tipo" 
          name="tipo"
          placeholder="Selecione o tipo">
        </p-dropdown>
      </div>
    </div>
    
    <div class="field">
      <label>Custo (R$)</label>
      <p-inputNumber 
        [(ngModel)]="novaQueima.custo" 
        name="custo" 
        mode="currency" 
        currency="BRL" 
        locale="pt-BR"
        placeholder="0,00">
      </p-inputNumber>
    </div>
    
    <div class="field">
      <label>Observações</label>
      <textarea pInputTextarea rows="2" [(ngModel)]="novaQueima.observacoes" name="observacoes" placeholder="Observações sobre a queima"></textarea>
    </div>
  </form>
  
  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" class="p-button-text" (click)="dialogQueimaVisivel=false"></button>
    <button pButton label="Agendar Queima" (click)="agendarQueima()" [disabled]="!novaQueima.data || !novaQueima.tipo"></button>
  </ng-template>
</p-dialog>
